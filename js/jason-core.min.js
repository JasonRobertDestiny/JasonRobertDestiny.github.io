// Jason's Blog Core JavaScript Functions v2.0
// Optimized for performance and SEO

// Reading Progress Bar
function initReadingProgress() {
    const progressBar = document.getElementById('reading-progress');
    if (!progressBar) return;
    
    function updateProgress() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = (scrollTop / scrollHeight) * 100;
        progressBar.style.width = Math.min(progress, 100) + '%';
    }
    
    window.addEventListener('scroll', updateProgress, {passive: true});
    window.addEventListener('resize', updateProgress, {passive: true});
    updateProgress();
}

// Back to Top functionality
function initBackToTop() {
    const backToTopBtn = document.getElementById('back-to-top');
    if (!backToTopBtn) return;
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.add('show');
        } else {
            backToTopBtn.classList.remove('show');
        }
    }, {passive: true});
}

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Floating Menu functionality
function toggleFloatingMenu() {
    const menu = document.getElementById('floating-menu');
    menu?.classList.toggle('active');
}

function openSearch() {
    const searchPage = document.querySelector('.search-page');
    if (searchPage) {
        searchPage.classList.add('show');
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            setTimeout(() => searchInput.focus(), 300);
        }
    }
    toggleFloatingMenu();
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    toggleFloatingMenu();
}

function printPage() {
    window.print();
    toggleFloatingMenu();
}

// Social Share functionality
function initSocialShare() {
    document.addEventListener('click', function(e) {
        const searchPage = document.querySelector('.search-page');
        const floatingMenu = document.getElementById('floating-menu');
        
        if (searchPage?.classList.contains('show') && 
            !e.target.closest('.search-main') && !e.target.closest('.search-icon-close')) {
            searchPage.classList.remove('show');
        }
        
        if (floatingMenu?.classList.contains('active') && 
            !e.target.closest('.floating-menu')) {
            floatingMenu.classList.remove('active');
        }
    });
    
    const closeBtn = document.querySelector('.search-icon-close');
    closeBtn?.addEventListener('click', function() {
        document.querySelector('.search-page')?.classList.remove('show');
    });
}

// Social sharing functions
function shareToTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(document.title);
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function shareToFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
}

function shareToLinkedIn() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}&title=${title}`, '_blank', 'width=600,height=400');
}

function shareToWechat() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        alert('链接已复制到剪贴板，请在微信中粘贴分享！');
    }).catch(function() {
        prompt('请复制以下链接在微信中分享：', window.location.href);
    });
}

function shareToWeibo() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://service.weibo.com/share/share.php?url=${url}&title=${title}`, '_blank', 'width=600,height=400');
}

// Lazy loading implementation
function initLazyLoading() {
    const images = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('lazy');
                imageObserver.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}

// Search functionality
function htmlDecode(input) {
    const e = document.createElement('textarea');
    e.innerHTML = input;
    return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
}

function initSimpleJasonSearch() {
    if (typeof SimpleJekyllSearch !== 'undefined') {
        SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('search-results'),
            json: '/search.json',
            searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
            noResultsText: 'No results',
            limit: 50,
            fuzzy: false,
            templateMiddleware: function (prop, value, template) {
                if (prop === 'subtitle' || prop === 'title') {
                    if (value.indexOf("code")) {
                        return htmlDecode(value);
                    } else {
                        return value;
                    }
                }
            }
        });
    }
}

// Initialize all functionality
document.addEventListener('DOMContentLoaded', function() {
    initReadingProgress();
    initBackToTop();
    initSocialShare();
    initLazyLoading();
});

// Async script loading utility
function loadScript(src, callback) {
    const script = document.createElement('script');
    script.src = src;
    script.async = true;
    if (callback) script.onload = callback;
    document.head.appendChild(script);
}